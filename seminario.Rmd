---
title: "seminario fuentes sobre el impacto del agua y el tabaquismo en el cancer de colon"
subtitle: "Fuentes de datos Biomédicas y Web semántica, Grado de Ingeniería de la Salud"
author: "Álvaro Martín,Miguel Soriano, Andres Arribas"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# **Introducción**
El cáncer de colon es una de las enfermedades oncológicas más comunes, la cual ocasiona incontables perdidas cada año en todo el mundo. A lo largo de este proyecto, tratamos distintas bases de datos donde se estudia su prevalencia, su impacto y como se relaciona con dos importantes factores que afectan a la salud: el tabaquismo y la calidad del agua.

Por un lado, el tabaquismo, es ampliamente estudiado como factor de riesgo para diferentes tipos de cáncer; afectando tambien al colon dado que las sustancias químicas del tabaco dañan las células intestinales promoviendo su crecimiento anormal.

Por otro lado, la calidad del agua también es crucial en la salud gastrointestinal ya que su exposición a químicos nocivos puede afectar negativamente a la salud digestiva.

Hemos elegido centrarnos solo en la region de Asturias en España dados los datos encontrados, los cuales hemos usado para explorar esta posible relacion entre estos dos factores y el cancer de colon.

## **Objetivos**
El propósito principal de este estudio es explorar y entender la relación entre el tabaquismo, la calidad del agua, y la incidencia del cáncer de colon en la region de asturias. Para lograr esto, hemos establecido los siguientes objetivos específicos:

1. **Analizar la prevalencia del tabaquismo**: Estudiar la prevalencia del tabaquismo en la region de asturias y su correlación con la incidencia del cáncer de colon.

2. **Evaluar la calidad del agua**: Investigar la calidad del agua en la region de asturias y su posible relación con la incidencia del cáncer de colon.

3. **Investigar la incidencia del cáncer de colon**: Analizar la incidencia del cáncer en la region de asturias y su posible correlación con el tabaquismo y la calidad del agua.

4. **Explorar la interacción entre estos factores**: Investigar cómo el tabaquismo y la calidad del agua pueden interactuar entre sí y su impacto conjunto en la incidencia del cáncer de colon basandonos en los datos hallados de la region de asturias.

A través de estos objetivos, esperamos proporcionar una visión más completa de cómo estos factores pueden influir en la salud humana y contribuir al conocimiento de la incidencia del cáncer de colon.

# Importación de las librerias necesarias 
En este apartado añadimos todas las librerias necesarias para realizar el trabajo
```{r}
library(tidyverse)
library(readxl)
library(readr)
library(jsonlite)
library(dplyr)
library(tidyr)
```
# Importacion de las fuentes de datos 

En este apartado añadimos las diferentes fuentes de datos que hemos utilizado para el estudio directamente utilizando los formatos csv y JSON para poder manipular los datos
```{r}
#esta base de datos tiene informacion pero no es relevante al ser del pais vasco
#carga de datos xlsx sobre calidad de agua en pais vasco
datos_paisVasco <- read_excel("INPUT/DATA/control_analitico.xlsx")
str(datos_paisVasco)
summary(datos_paisVasco)
#View(datos_paisVasco)

#carga de datos csv sobre calidad de agua en gijon
Agua_gijon <- read_delim("INPUT/DATA/731.csv", 
                      delim = ",", escape_double = FALSE, trim_ws = TRUE)
Agua_gijon
summary(Agua_gijon)
#View(Agua_gijon)
table(Agua_gijon$T.RED)


#carga de datos json sobre los fumadores en asturias incluyendo a gijon
#esta hay que abrirla bien
# Cargar las librerías necesarias
library(tidyverse)
library(jsonlite)

# Cargar el archivo JSON de fumadores y transformarlo en un tibble
datos_fumadores <- fromJSON("INPUT/DATA/Fumadores.json", flatten = TRUE) %>%
  as_tibble()

# Separar la columna 'Nombre' en 'Sexo', 'Region', y 'Categoria' usando la coma como delimitador
datos_fumadores <- datos_fumadores %>%
  separate(Nombre, into = c("Sexo", "Region", "Categoria"), sep = ", ", fill = "right")

# Visualizar los datos para confirmar la estructura
#View(datos_fumadores)
summary(datos_fumadores)


#carga de cancer de colon
# Cargar la librería necesaria
library(readxl)

# Cargar el archivo Excel, omitiendo las primeras 6 filas y usando la fila 7 como encabezado
datosEnfermedades <- read_excel("INPUT/DATA/03009d.xlsx", skip = 5)

# Visualizar la tabla general
#View(datosEnfermedades)
summary(datosEnfermedades)




```


```{r}
# Cargar librerías necesarias
library(tidyverse)
library(jsonlite)

# Cargar el archivo JSON de fumadores
datos_fumadores <- fromJSON("INPUT/DATA/Fumadores.json", flatten = TRUE) %>%
  as_tibble()

# Separar la columna 'Nombre' y filtrar por región
fumadores_asturias <- datos_fumadores %>%
  separate(Nombre, into = c("Sexo", "Region", "Categoria"), sep = ", ", fill = "right") %>%
  filter(Region == "Asturias (Principado de)")

# Extraer el primer valor de cada lista en MetaData y Data, si hay múltiples valores
fumadores_asturias_expandido <- fumadores_asturias %>%
  mutate(
    Variable_Nombre = map(MetaData, ~ .x[["Variable.Nombre"]][1]),
    Variable_Codigo = map(MetaData, ~ .x[["Variable.Codigo"]][1]),
    Valor = map(Data, ~ .x[["Valor"]][1])
  ) %>%
  # Convertir las listas resultantes en columnas de caracteres para un dataframe limpio
  unnest(c(Variable_Nombre, Variable_Codigo, Valor))

# Seleccionar columnas relevantes
fumadores_asturias_final <- fumadores_asturias_expandido %>%
  select(Sexo, Region, Categoria, Variable_Nombre, Variable_Codigo, Valor)

# Verificar los resultados
#View(fumadores_asturias_final)
summary(fumadores_asturias_final)

#carga de datos xlsx sobre algunas enfermedades en asturias, entre ellas el cancer de colon
datosEnfermedades <-  read_excel("INPUT/DATA/03009d.xlsx")
str(datosEnfermedades)
summary(datosEnfermedades)
#View(datosEnfermedades)

```

# Cambios en las fuentes de datos
Este paso es necesario ya que al relacionar todas las tablas entre si necesitamos que aquellas columnas que son comunes tengan los mismos nombres, por ello se ha requerido que todos los nombres de las comunidades y ciudades autonomas presentes sean cambiados a nombres comunes elegidos por el grupo. Por otro lado hemos usado el select para seleccionar las columnas de datos que nos resultan de interes para el estudio.

```{r}
agua_gijon <- agua_gijons%>%
  mutate(
    CCAA= case_when( ## cambiamos el nombre con un case_When
      fumadores$`Comunidades y Ciudades Autónomas`== "Andalucía" ~ "Andalucia",
      fumadores$`Comunidades y Ciudades Autónomas`== "Aragón" ~ "Aragon",
      fumadores$`Comunidades y Ciudades Autónomas`== "Asturias (Principado de)" ~ "Asturias",
      fumadores$`Comunidades y Ciudades Autónomas`== "Balears (Illes)" ~ "Baleares",
      fumadores$`Comunidades y Ciudades Autónomas`== "Canarias" ~ "Canarias",
      fumadores$`Comunidades y Ciudades Autónomas`== "Cantabria" ~ "Cantabria",
      fumadores$`Comunidades y Ciudades Autónomas`== "Castilla y León" ~ "CyL",
      fumadores$`Comunidades y Ciudades Autónomas`== "Castilla - La Mancha" ~ "Castilla la Mancha",
      fumadores$`Comunidades y Ciudades Autónomas`== "Cataluña" ~ "Cataluña",
      fumadores$`Comunidades y Ciudades Autónomas`== "Comunitat Valenciana" ~ "C.Valencia",
      fumadores$`Comunidades y Ciudades Autónomas`== "Extremadura" ~ "Extremadura",
      fumadores$`Comunidades y Ciudades Autónomas`== "Galicia" ~ "Galicia",
      fumadores$`Comunidades y Ciudades Autónomas`== "Madrid (Comunidad de)" ~ "Madrid",
      fumadores$`Comunidades y Ciudades Autónomas`== "Murcia (Región de)" ~ "Murcia",
      fumadores$`Comunidades y Ciudades Autónomas`== "Navarra (Comunidad Foral de)" ~ "Navarra",
      fumadores$`Comunidades y Ciudades Autónomas`== "País Vasco" ~ "País Vasco",
      fumadores$`Comunidades y Ciudades Autónomas`== "Rioja (La)" ~ "La Rioja",
      fumadores$`Comunidades y Ciudades Autónomas`== "Ceuta (Ciudad Autónoma de)" ~ "Ceuta",
      fumadores$`Comunidades y Ciudades Autónomas`== "Melilla (Ciudad Autónoma de)" ~ "Melilla",
    )) %>%
select(`CCAA`,`Consumo de tabaco`,Total,) %>%
  na.exclude()%>%
  filter(`Consumo de tabaco` != "TOTAL")
fumadores
      
```


=======
#cancer de colon filtrado por hombre y mujer
# Cargar la librería necesaria
library(readxl)
library(dplyr)

# Cargar el archivo Excel, omitiendo las filas iniciales de encabezado
datosEnfermedades <- read_excel("INPUT/DATA/03009d.xlsx", skip = 5)

# Filtrar filas relevantes para "Cáncer de colon" y sus subtotales
cancer_colon <- datosEnfermedades %>%
  filter(str_detect(datosEnfermedades[[1]], "Cáncer de colon|Total|Hombres|Mujeres")) %>%
  slice(which(str_detect(datosEnfermedades[[1]], "Cáncer de colon")):
        (which(str_detect(datosEnfermedades[[1]], "Cáncer de colon")) + 3))

# Visualizar los datos filtrados de Cáncer de colon
#View(cancer_colon)
summary(cancer_colon)
```

```{r}
# Cargar las librerías necesarias
library(dplyr)
library(tidyr)

# Paso 1: Filtrar y preparar los datos de tabaquismo para Asturias
# Aquí trabajamos con la tabla fumadores_asturias_final ya filtrada para Asturias
fumadores_asturias_prevalencia <- fumadores_asturias_final %>%
  filter(Categoria %in% c("Fumador diario", "Ex fumador")) %>%
  select(Sexo, Categoria, Valor) %>%
  spread(key = Categoria, value = Valor)

# Visualizar la prevalencia de fumadores en Asturias
#View(fumadores_asturias_prevalencia)

# Paso 2: Preparar los datos de cáncer de colon para Asturias (ya específico para Asturias en la carga inicial)
# Seleccionar solo las columnas que contienen datos mensuales
cancer_colon_asturias <- datosEnfermedades %>%
  filter(grepl("Cáncer de colon", .[[1]], ignore.case = TRUE)) %>%
  select(-1) %>%
  gather(key = "Mes", value = "Defunciones", -1)

# Visualizar los datos de defunciones por cáncer de colon en Asturias
#View(cancer_colon_asturias)

# Paso 3: Realizar el análisis de correlación entre tabaquismo y cáncer de colon

# Calcular la media de defunciones de cáncer de colon para cada mes
cancer_colon_promedio <- cancer_colon_asturias %>%
  group_by(Mes) %>%
  summarise(Defunciones = mean(Defunciones, na.rm = TRUE))

# Calcular la media de prevalencia de fumadores (Fumador diario y Ex fumador)
fumadores_promedio <- fumadores_asturias_prevalencia %>%
  summarise(Fumador_diario = mean(`Fumador diario`, na.rm = TRUE),
            Ex_fumador = mean(`Ex fumador`, na.rm = TRUE))

# Combinar ambos conjuntos de datos y calcular la correlación entre la prevalencia de fumadores diarios y defunciones por cáncer de colon
correlacion_fumador_diario <- cor(cancer_colon_promedio$Defunciones, fumadores_promedio$Fumador_diario, use = "complete.obs")
correlacion_ex_fumador <- cor(cancer_colon_promedio$Defunciones, fumadores_promedio$Ex_fumador, use = "complete.obs")


print(paste("Correlación entre fumadores diarios y defunciones por cáncer de colon:", correlacion_fumador_diario))
print(paste("Correlación entre ex fumadores y defunciones por cáncer de colon:", correlacion_ex_fumador))


```
fumadores ejercicio 1
```{r}
# Extraer solo los campos necesarios del JSON
fumadores_asturias <- datos_fumadores %>%
  mutate(
    Valor = map_dbl(Data, ~ if (!is.null(.x$Valor)) .x$Valor else NA_real_)
  ) %>%
  select(Nombre, Valor) %>%
  filter(grepl("Asturias", Nombre))

# Ver los resultados
print(fumadores_asturias)

# Filtrar datos relevantes (por ejemplo, Fumador diario, ocasional, etc.)
fumadores_relevantes <- fumadores_asturias %>%
  filter(
    grepl("Fumador diario|Fumador ocasional|Ex fumador|Nunca ha fumado", Nombre)
  )

# Ver los datos filtrados
print(fumadores_relevantes)

```

cancer de colon ejercicio 1
```{r}
# Cargar los datos de enfermedades (asegúrate de que el archivo esté correctamente cargado)
datosEnfermedades <- read_excel("INPUT/DATA/03009d.xlsx")

# Filtrar y organizar los datos relacionados con "Cáncer de colon"
cancer_colon_final <- datosEnfermedades %>%
  filter(grepl("Cáncer de colon|Total|Hombres|Mujeres", `...1`)) %>%  # Filtrar categorías relevantes
  select(`...1`, Total, ENERO, FEBRERO, MARZO, ABRIL, MAYO) %>%  # Seleccionar columnas relevantes
  rename(
    Categoria = `...1`  # Renombrar la columna principal
  ) %>%
  filter(row_number() %in% (which(grepl("Cáncer de colon", Categoria))[1]:(which(grepl("Cáncer de colon", Categoria))[1] + 3))) %>%  # Seleccionar "Cáncer de colon" y las 3 filas siguientes
  mutate(across(Total:MAYO, as.numeric))  # Convertir las columnas numéricas

# Verificar el resultado final
print(cancer_colon_final)

```

